apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
- ../multus-common

images:
- name: multus-cni
  newName: ghcr.io/k8snetworkplumbingwg/multus-cni
  newTag: v3.9.2

patches:
- target:
    kind: DaemonSet
    name: kube-multus-ds
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/command
      value: ["/entrypoint.sh"]
    - op: replace
      path: /spec/template/spec/containers/0/args
      value:
        - "--multus-conf-file=auto"
        - "--cni-version=0.3.1"
        - "--multus-master-cni-file-name=10-azure.conflist"
        - "--multus-log-level=error"
        - "--multus-log-file=/var/log/neon-multus.log"
    - op: add
      path: /spec/template/spec/containers/-
      value:
        name: self-restart
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        image: bitnami/kubectl:1.28
        command:
          - "/bin/sh"
          - "-c"
          - sleep 3540 && kubectl delete pod -n $(POD_NAMESPACE) $(POD_NAME)
